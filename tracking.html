<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tracking - COFFEE & BLOOM</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #fff8f5;
    text-align: center;
    padding: 80px 20px 20px 20px;
    margin: 0;
  }
  h1 { color: #6b4226; margin-bottom: 10px; }
  #status-text { color: #6b4226; font-weight: 600; margin-bottom: 20px; font-size: 18px; }
  #map { height: 600px; width: 90%; max-width: 900px; margin: 0 auto; border-radius: 15px; }
  .back-btn {
    position: absolute; top: 15px; left: 15px; z-index:1000;
    background:#6b4226; border:none; color:#fff; padding:0.5rem 1rem;
    border-radius:12px; cursor:pointer; font-weight:600;
  }
  .motorcycle-emoji { font-size: 30px; }
</style>
</head>
<body>

<button class="back-btn" onclick="history.back()">‚Üê Back</button>
<h1>Track Your Order üèçÔ∏è</h1>
<p id="status-text">Status: Waiting for Confirmation</p>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjA5MDUyYzIyYzc4NDRhMTBiZjE3M2I1NGRlYmFmMTNiIiwiaCI6Im11cm11cjY0In0=';

// Store coordinates
const STORE = { lat: 10.2619, lng: 123.8530 };

// Elements
const statusEl = document.getElementById('status-text');

// Map initialization
const map = L.map('map').setView([STORE.lat, STORE.lng], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Markers
L.marker([STORE.lat, STORE.lng]).addTo(map).bindPopup("<b>üè† COFFEE & BLOOM Store</b>").openPopup();

// Motorcycle marker
const motorcycleMarker = L.marker([STORE.lat, STORE.lng], {
  icon: L.divIcon({ html: 'üèçÔ∏è', className: 'motorcycle-emoji', iconSize:[30,30], iconAnchor:[15,15] })
}).addTo(map);

let routeLine, routeLatLngs = [];
let animationRunning = false;

// Fetch last order
function getLastOrder() {
  const orders = JSON.parse(localStorage.getItem('orders')) || [];
  return orders.length ? orders[orders.length - 1] : null;
}

// Fetch route from ORS
async function fetchRoute(delivery) {
  const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${STORE.lng},${STORE.lat}&end=${delivery.lng},${delivery.lat}`;
  const res = await fetch(url);
  const data = await res.json();
  const coords = data.features[0].geometry.coordinates;
  routeLatLngs = coords.map(c => [c[1], c[0]]);
  drawRoute(routeLatLngs);
}

function drawRoute(latlngs) {
  if(routeLine) routeLine.remove();
  routeLine = L.polyline(latlngs, { color:'red', weight:5 }).addTo(map);
  map.fitBounds(routeLine.getBounds(), { padding:[50,50] });
}

// Animate motorcycle along route
function animateAlongRoute(marker, latlngs, speed=0.003) {
  if(animationRunning) return;
  if(!latlngs || latlngs.length < 2) return;
  animationRunning = true;
  let i = 0, progress = 0;
  function move() {
    if(i >= latlngs.length - 1) { animationRunning = false; return; }
    const [lat1, lng1] = latlngs[i];
    const [lat2, lng2] = latlngs[i+1];
    const deltaLat = lat2 - lat1;
    const deltaLng = lng2 - lng1;
    progress += speed;
    if(progress >= 1) { progress = 0; i++; }
    const lat = lat1 + deltaLat * progress;
    const lng = lng1 + deltaLng * progress;
    marker.setLatLng([lat, lng]);
    requestAnimationFrame(move);
  }
  move();
}

// Update tracking info
function updateTracking() {
  const lastOrder = getLastOrder();
  if(!lastOrder || !lastOrder.location) {
    statusEl.textContent = "No active orders.";
    motorcycleMarker.setLatLng([STORE.lat, STORE.lng]);
    animationRunning = false;
    if(routeLine) routeLine.remove();
    return;
  }

  const DELIVERY = lastOrder.location;
  L.marker([DELIVERY.lat, DELIVERY.lng]).addTo(map).bindPopup("<b>üìç Your Delivery Location</b>").openPopup();

  // Update status text
  statusEl.textContent = `Status: ${lastOrder.status || "Waiting for Confirmation"}`;

  // Fetch route if not yet fetched
  if(!routeLatLngs.length) fetchRoute(DELIVERY);

  // Animate motorcycle only if on the way
  if(lastOrder.status === "On the Way") {
    animateAlongRoute(motorcycleMarker, routeLatLngs, 0.003);
  } else if(lastOrder.status === "Delivered") {
    motorcycleMarker.setLatLng([DELIVERY.lat, DELIVERY.lng]).bindPopup("‚úÖ Delivered!").openPopup();
    animationRunning = false;
  } else {
    motorcycleMarker.setLatLng([STORE.lat, STORE.lng]);
    animationRunning = false;
  }
}

// Live updates
window.addEventListener('storage', updateTracking);
setInterval(updateTracking, 1000); // fallback
updateTracking(); // initial call
</script>

</body>
</html>
